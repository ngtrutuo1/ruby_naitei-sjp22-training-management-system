<div class="container-fluid py-4">
  <!-- Title with gradient underline -->
  <div class="d-flex align-items-center mb-4">
    <h2 class="font-weight-bold text-primary mb-0"><%= t(".title") %></h2>
    <div class="ml-3 flex-grow-1">
      <div class="title-gradient-underline"></div>
    </div>
  </div>

  <div class="row">
    <!-- Main Content -->
    <div class="col-md-8">
      <!-- Student Info Card -->
      <div class="card shadow-sm mb-4 border-0">
        <div class="card-body p-4">
          <div class="row">
            <div class="col-md-3 col-lg-2 mb-3 mb-md-0 text-center">
              <% if current_user.image&.present? %>
                <%= image_tag current_user.image, class: "rounded-lg img-thumbnail shadow-sm user-image" %>
              <% else %>
                <%= image_tag Settings.image_user_default, class: "rounded-lg img-thumbnail shadow-sm user-image" %>
              <% end %>
            </div>
            <div class="col-md-9 col-lg-10">
              <h5 class="mb-2 font-weight-bold text-uppercase text-dark letter-spacing-1"><%= current_user.name %></h5>
              <div class="d-flex flex-wrap align-items-center mb-2">
                <div class="bg-light rounded-pill px-3 py-1 mr-3 mb-2 d-inline-flex align-items-center">
                  <i class="fas fa-calendar-alt text-primary mr-2"></i>
                  <span class="text-secondary">
                    <%= l(@course.start_date, format: :short) %> â†’ <span class="text-primary font-weight-bold"><%= l(@course.finish_date, format: :short) %></span>
                  </span>
                </div>
                <div class="bg-light rounded-pill px-3 py-1 mb-2 d-inline-flex align-items-center">
                  <i class="fas fa-info-circle text-primary mr-2"></i>
                  <span class="text-secondary mr-2"><%= t(".course_details") %></span>
                  <span class="badge badge-pill badge-warning text-dark align-middle mr-2"><%= t(".status.#{@course.status}") %></span>
                  <span class="text-dark">[<%= @course.name %>]</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Progress Bar Card -->
      <div class="card shadow-sm mb-4 border-0">
        <div class="card-body p-4">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0 d-flex align-items-center">
              <i class="fas fa-book text-primary mr-2"></i>
              <%= t(".progress_title") %> <%= @subject.name %>
            </h5>
            <span class="badge badge-pill badge-primary badge-large-custom"><%= count_process_tasks(@tasks) %>%</span>
          </div>
          <div class="progress progress-custom">
            <div class="progress-bar bg-primary" role="progressbar" data-progress-width="<%= count_process_tasks(@tasks) %>" aria-valuenow="<%= count_process_tasks(@tasks) %>" aria-valuemin="0" aria-valuemax="100"></div>
          </div>
        </div>
      </div>

      <!-- Task List -->
      <div class="card shadow-sm mb-4 border-0">
        <div class="card-header bg-white border-0">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0 text-primary">
              <i class="fas fa-tasks mr-2"></i>
              <%= t(".task_list_title") %> (<%= @tasks.count %>)
            </h5>
          </div>
        </div>
        <div class="card-body py-0">
          <div class="list-group list-group-flush">
            <% @tasks.each do |task| %>
              <%= render "trainee/subjects/task_details", task: task, user_subject: @user_subject %>
            <% end %>
          </div>
        </div>
      </div>

      <!-- Subject Assessment -->
      <div class="card shadow-sm mb-4 border-0">
        <div class="card-header bg-white border-0">
          <h5 class="mb-0 text-primary">
            <i class="fas fa-clipboard-check mr-2"></i>
            <%= t(".assessment_title") %>
          </h5>
        </div>
        <div class="card-body">
          <div class="rounded p-3 mb-4">
            <div class="d-flex align-items-center">
              <div class="mr-4">
                <div class="text-secondary mb-1"><%= t(".assessment_score") %></div>
                <div class="d-flex align-items-baseline">
                  <span class="h2 font-weight-bold text-primary mb-0"><%= @user_subject.score %></span>
                  <span class="mx-2 text-secondary">/</span>
                  <span class="h5 text-secondary mb-0"><%= Settings.user_subject.max_score %></span>
                </div>
              </div>
              <div class="flex-grow-1">
                <div class="progress progress-score-custom">
                  <div class="progress-bar bg-success" role="progressbar" data-progress-width="<%= count_score_subject(@user_subject) %>" aria-valuenow="<%= count_score_subject(@user_subject) %>" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
              </div>
            </div>
          </div>

          <h6 class="font-weight-bold text-dark mb-3"><%= t(".comments_title") %></h6>
          <% if @comments.any? %>
            <%= render partial: "trainee/subjects/comment_list", collection: @comments, as: :comment %>
          <% else %>
            <div class="text-center text-muted py-4">
              <i class="fas fa-comments fa-2x mb-3"></i>
              <p><%= t(".no_comments") %></p>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Right Sidebar -->
    <div class="col-md-4">
      <div class="card shadow-sm border-0 mb-4 sidebar-card">
        <div class="card-header border-0 py-3">
          <div class="text-center">
            <h2 class="mb-0 font-weight-bold sidebar-header"><%= @subject.name %></h2>
          </div>
        </div>
        <div class="card-body">
          <div class="d-flex justify-content-center mb-4">
            <div class="px-4 py-2 rounded-pill text-center border">
              <% if @course_subject.start_date.present? && @course_subject.finish_date.present? %>
                <span class="text-dark duration-pill"><%= t(".duration") %>: <span class="font-weight-bold"><%= (@course_subject.finish_date - @course_subject.start_date).to_i %> <%= t(".day") %></span></span>
              <% end %>
            </div>
          </div>

          <div class="rounded-lg p-3 mb-4">
            <div class="row mb-3">
              <div class="col-6">
                <div class="d-flex align-items-center">
                  <div class="color-dot-danger"></div>
                  <span class="text-muted"><%= t(".start") %></span>
                </div>
              </div>
              <div class="col-6 text-right font-weight-bold">
                <% if @course_subject.start_date.present? && @course_subject.finish_date.present? %>
                  <%= l(@course_subject.start_date, format: :short) %>
                <% end %>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-6">
                <div class="d-flex align-items-center">
                  <div class="color-dot-warning"></div>
                  <span class="text-muted"><%= t(".deadline") %></span>
                </div>
              </div>
              <div class="col-6 text-right font-weight-bold">
                <% if @course_subject.start_date.present? && @course_subject.finish_date.present? %>
                  <%= l(@course_subject.finish_date, format: :short) %>
                <% end %>
              </div>
            </div>

            <div class="p-3 rounded-lg border">
              <div class="row mb-3">
                <div class="col-12 mb-1">
                  <label class="text-muted mb-1"><%= t(".actual_start_date") %></label>
                  <div class="input-group">
                    <div class="input-group-prepend">
                      <span class="input-group-text border">
                        <i class="fas fa-calendar-day text-primary"></i>
                      </span>
                    </div>
                    <% if @user_subject.completed_at.nil? %>
                      <input type="date" id="actual_start_date" class="form-control border" value="<%= @user_subject.started_at&.to_date %>">
                    <% else %>
                      <input type="date" id="actual_start_date" class="form-control border" value="<%= @user_subject.started_at&.to_date %>" disabled>
                    <% end %>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-12">
                  <label class="text-muted mb-1"><%= t(".actual_end_date") %></label>
                  <div class="input-group">
                    <div class="input-group-prepend">
                      <span class="input-group-text border">
                        <i class="fas fa-calendar-check text-primary"></i>
                      </span>
                    </div>
                    <% if @user_subject.completed_at.nil?%>
                      <input type="date" id="actual_end_date" class="form-control border" value="<%= @user_subject.completed_at&.to_date %>">
                    <% else %>
                      <input type="date" id="actual_end_date" class="form-control border" value="<%= @user_subject.completed_at&.to_date %>" disabled>
                    <% end %>
                  </div>
                </div>
              </div>
            </div>
          </div>
            <div class="text-center mb-4 mt-5">
            <h5 class="font-weight-bold text-uppercase text-dark letter-spacing-1 mb-3"><%= t(".subject_status") %></h5>
            <% display_status = @user_subject.display_status %>
            <% if display_status.to_sym == :in_progress || display_status.to_sym == :overdue_and_not_finished %>
              <button class="btn btn-success btn-block font-weight-bold" onclick="toggleFinishConfirm()">
                <i class="fas fa-check mr-2"></i><%= t(".finish") %>
              </button>
            <% elsif display_status.to_sym == :not_started %>
              <button class="btn btn-secondary btn-block font-weight-bold" disabled>
                <i class="fas fa-check-circle mr-2"></i><%= t(".not_started") %>
              </button>
            <% else %>
              <button class="btn btn-secondary btn-block font-weight-bold" disabled>
                <i class="fas fa-check-circle mr-2"></i><%= t(".finished") %>
              </button>
            <% end %>

            <!-- Confirm Finish Section (Collapsible) -->
            <div id="finishConfirmSection" class="collapse mt-3">
              <div class="card border-warning">
                <div class="card-header bg-warning text-dark">
                  <h6 class="mb-0">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    <%= t(".confirm_finish_title") %>
                  </h6>
                </div>
                <div class="card-body p-3">
                  <% unfinished_tasks = unfinished_tasks(@user_subject) %>
                  <% if unfinished_tasks.any? %>
                    <div class="text-center mb-3">
                      <div class="icon-circle-custom bg-warning text-white mb-2">
                        <i class="fas fa-exclamation-triangle"></i>
                      </div>
                      <p class="mb-2 small text-muted"><%= t(".unfinished_tasks", count: unfinished_tasks.count) %></p>
                    </div>
                  <% else %>
                    <div class="text-center mb-3">
                      <div class="icon-circle-custom bg-success text-white mb-2">
                        <i class="fas fa-check"></i>
                      </div>
                      <p class="mb-2 small text-success"><%= t(".all_tasks_completed") %></p>
                    </div>
                  <% end %>

                  <div class="d-flex justify-content-between align-items-center">
                    <%= render "trainee/subjects/form_finish_subject", user_subject: @user_subject, course_subject: @course_subject %>
                  </div>
                </div>
              </div>
            </div>
            </div>

        </div>
      </div>
    </div>
  </div>
</div>
